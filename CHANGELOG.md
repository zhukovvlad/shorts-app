# Changelog

Все значительные изменения в этом проекте будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.6.0] - 2025-10-05

### Добавлено
- **Автоматизированное тестирование**
  - Установлен Jest с TypeScript поддержкой
  - Создан test suite для logger с 10 автоматизированными тестами
  - 84.48% покрытие кода для модуля logger
  - Документация по тестированию в `TESTING.md`
  - Тестовые скрипты в package.json: `test`, `test:watch`, `test:coverage`

- **Bash скрипты ротации логов**
  - Strict mode (`set -euo pipefail`) для раннего обнаружения ошибок
  - Валидация LOG_DIR перед выполнением операций
  - Аудит логирование всех операций удаления файлов
  - Null-delimited обработка имен файлов (поддержка пробелов и newlines)

### Исправлено
- **Логирование**
  - Завершена миграция на централизованный logger (заменен последний `console.error`)
  - Все файлы теперь используют единообразное логирование

- **Code Quality**
  - Исправлена lint ошибка `noSwitchDeclarations` в `app/actions/processes.ts`
  - Case блоки обернуты в фигурные скобки для изоляции переменных

- **Docker**
  - Исправлена проблема "Cannot find package.json" в worker контейнере
  - Добавлены package.json и production dependencies в runner stage
  - Скопированы необходимые директории (worker/, app/, lib/)

- **Скрипты ротации логов**
  - Исправлены race conditions через copy-truncate подход
  - Условное удаление: временные файлы удаляются только после успешного gzip
  - Восстановление данных при ошибке сжатия
  - Корректная обработка файлов с пробелами в именах

### Изменено
- **Docker Compose**
  - Worker команда изменена с `npm run worker` на `npx tsx worker/worker.ts`

- **Скрипты ротации логов**
  - Все операции удаления теперь логируются с метками `DELETING:` и `ERROR deleting`
  - Ошибки записываются в stderr для правильной обработки

### Удалено
- Старые ручные тестовые файлы:
  - `test-logger.ts`
  - `test-separated-loggers.ts`
  - `test-retry-notifications.js`
  - `test-checkpoint-system.js`

### Безопасность
- Добавлена валидация прав доступа к LOG_DIR
- Безопасная обработка любых имен файлов в bash скриптах
- Предотвращение потери данных при ротации логов

---

## [1.5.0] - 2025-10-05

### Добавлено
- **Redis оптимизация и безопасность**
  - Адаптивный polling с замедлением с 1s до 3-8s
  - Батчинг Redis операций через Pipeline
  - Санитизация ошибок (удаление путей, токенов, IP)
  - Документация безопасности в `REDIS_OPTIMIZATION_AND_SECURITY.md`

### Изменено
- Polling интервал увеличен с 1s до 3s (-66% запросов)
- Убрано явное удаление прогресса (полагаемся на TTL)

### Результат
- **-70% экономия Redis запросов** (500K → 150K в месяц)
- Запас до 350K запросов = 2.3× больше видео

---

## [1.4.0] - 2025-10-05

### Добавлено
- **Система уведомлений о ретраях**
  - Toast уведомления для всех критических событий
  - Детальные сообщения об ошибках
  - Информация о номере попытки и оставшихся ретраях

- **Redis Checkpoint система**
  - Сохранение прогресса каждого шага
  - Продолжение с места ошибки при ретрае
  - Экономия ~75% времени при повторных попытках
  - Fallback логика при недоступности Redis

### Исправлено
- Off-by-one ошибка в retry gate
- Исчезновение компонента прогресса при ошибке
- Прогресс теперь корректно начинается с 10%

---

## [1.3.0] - 2025-09

### Добавлено
- **Централизованная навигация**
  - Единый компонент Navigation.tsx
  - Контекстно-зависимые кнопки
  - Адаптивный дизайн

---

## [1.2.0] - 2025-09

### Добавлено
- **useVideoActions Hook**
  - Валидация URL протоколов
  - Улучшенная типизация TypeScript
  - Документация на русском

---

## Формат записей

### Добавлено (Added)
Новые функции и возможности.

### Изменено (Changed)
Изменения существующей функциональности.

### Устарело (Deprecated)
Функции, которые будут удалены в будущих версиях.

### Удалено (Removed)
Удаленные функции.

### Исправлено (Fixed)
Исправленные баги.

### Безопасность (Security)
Улучшения безопасности.

---

**Легенда версий:**
- **Major (X.0.0):** Несовместимые изменения API
- **Minor (0.X.0):** Новая функциональность, обратно совместимая
- **Patch (0.0.X):** Исправления багов, обратно совместимые
